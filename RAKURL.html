<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAKURL Security - Protección de Enlaces</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #6c5ce7;
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #6c5ce7;
            border-color: #6c5ce7;
        }
        .btn-primary:hover {
            background-color: #5a4fcf;
            border-color: #5a4fcf;
        }
        .result-container {
            display: none;
            margin-top: 20px;
        }
        .tab-content {
            padding: 20px;
        }
        .file-drop-area {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 30px;
            border: 2px dashed #6c5ce7;
            border-radius: 10px;
            transition: 0.2s;
            background-color: #f8f7ff;
            margin-bottom: 20px;
        }
        .file-drop-area:hover {
            background-color: #f0efff;
        }
        .file-drop-area.is-active {
            background-color: #e8e7ff;
        }
        .file-msg {
            font-size: 16px;
            font-weight: 500;
            color: #6c5ce7;
            margin-bottom: 10px;
        }
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            cursor: pointer;
            opacity: 0;
        }
        .error-message {
            display: none;
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        .error-key {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        .error-url {
            background-color: #fff8e1;
            color: #ff8f00;
            border-left: 4px solid #ff8f00;
        }
        .success-message {
            display: none;
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
            font-weight: 500;
        }
        .key-info {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e3f2fd;
            border-left: 4px solid #1976d2;
        }
        .key-info h5 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        .download-btn {
            background-color: #1976d2;
            border-color: #1976d2;
            margin-top: 10px;
        }
        .download-btn:hover {
            background-color: #1565c0;
            border-color: #1565c0;
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .logo-icon {
            width: 60px;
            height: 60px;
            background-color: #6c5ce7;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        .password-section {
            display: none;
            margin-top: 15px;
        }
        .nav-tabs .nav-link {
            color: #6c5ce7;
        }
        .nav-tabs .nav-link.active {
            color: white;
            background-color: #6c5ce7;
        }
        .debug-info {
            display: none;
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            color: #333;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <div class="logo-container">
                <div class="logo-icon">RAK</div>
            </div>
            <h1 class="display-4 fw-bold" style="color: #6c5ce7;">RAKURL Security</h1>
            <p class="lead">RANDOM ACCESS KEY URL SECURITY</p>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="protect-tab" data-bs-toggle="tab" data-bs-target="#protect" type="button" role="tab" aria-controls="protect" aria-selected="true">Proteger Enlace</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="access-tab" data-bs-toggle="tab" data-bs-target="#access" type="button" role="tab" aria-controls="access" aria-selected="false">Acceder a Enlace</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Pestaña para proteger enlaces -->
            <div class="tab-pane fade show active" id="protect" role="tabpanel" aria-labelledby="protect-tab">
                <div class="card">
                    <div class="card-header">
                        Proteger un enlace
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="urlInput" class="form-label">URL a proteger</label>
                            <input type="url" class="form-control" id="urlInput" placeholder="https://ejemplo.com" required="">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Método de protección</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="protectionMethod" id="keyMethod" value="key" checked>
                                <label class="form-check-label" for="keyMethod">
                                    Generar archivo .key (recomendado)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="protectionMethod" id="passwordMethod" value="password">
                                <label class="form-check-label" for="passwordMethod">
                                    Usar contraseña
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3 key-method-section">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>Al proteger el enlace, RAKURL Security generará automáticamente un archivo .key con una combinación de números aleatorios que servirá como clave para descifrar el enlace.
                            </div>
                        </div>
                        
                        <div class="mb-3 password-section">
                            <label for="passwordInput" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="passwordInput" placeholder="Ingresa una contraseña segura">
                            <div class="form-text">Usa una contraseña fuerte que puedas recordar. Esta será necesaria para acceder al enlace.</div>
                        </div>
                        
                        <button class="btn btn-primary" id="protectBtn">Proteger Enlace</button>
                        
                        <div class="error-message error-url" id="protectErrorUrl">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>La URL ingresada no es válida. Por favor, verifica e intenta nuevamente.
                        </div>
                        
                        <div class="error-message error-key" id="protectErrorKey">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Error al generar la clave. Por favor, intenta nuevamente.
                        </div>
                        
                        <div class="success-message" id="protectSuccess">
                            <i class="bi bi-check-circle-fill me-2"></i>¡Enlace protegido exitosamente con RAKURL Security! Copia el enlace generado y guarda tu método de acceso.
                        </div>
                        
                        <div class="key-info" id="keyInfo">
                            <h5><i class="bi bi-key-fill me-2"></i>Archivo de Clave Generado</h5>
                            <p>Se ha generado una clave de seguridad única. Descárgala y guárdala en un lugar seguro. La necesitarás para acceder al enlace.</p>
                            <button class="btn download-btn" id="downloadKeyBtn">
                                <i class="bi bi-download me-2"></i>Descargar Archivo .key
                            </button>
                        </div>
                        
                        <div class="result-container" id="protectResult">
                            <hr>
                            <h5>Enlace Protegido por RAKURL Security</h5>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="protectedUrl" readonly="">
                                <button class="btn btn-outline-secondary" type="button" id="copyProtectedUrl">Copiar</button>
                            </div>
                            <div class="alert alert-warning">
                                <strong>Importante:</strong> Guarda este enlace protegido y tu método de acceso (archivo .key o contraseña). Necesitarás ambos para acceder al enlace original.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña para acceder a enlaces -->
            <div class="tab-pane fade" id="access" role="tabpanel" aria-labelledby="access-tab">
                <div class="card">
                    <div class="card-header">
                        Acceder a un enlace protegido
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="protectedUrlInput" class="form-label">Enlace protegido</label>
                            <input type="text" class="form-control" id="protectedUrlInput" placeholder="Pega aquí el enlace protegido por RAKURL Security" required="">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Método de acceso</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="accessMethod" id="keyAccessMethod" value="key" checked>
                                <label class="form-check-label" for="keyAccessMethod">
                                    Usar archivo .key
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="accessMethod" id="passwordAccessMethod" value="password">
                                <label class="form-check-label" for="passwordAccessMethod">
                                    Usar contraseña
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3 key-access-section">
                            <label class="form-label">Cargar archivo clave (.key)</label>
                            <div class="file-drop-area" id="fileDropAreaAccess">
                                <span class="file-msg">Arrastra el archivo .key aquí o haz clic para seleccionarlo</span>
                                <input class="file-input" type="file" id="keyFileInputAccess" accept=".key">
                            </div>
                            <div class="form-text">Usa el archivo .key que generó RAKURL Security al proteger el enlace.</div>
                        </div>
                        
                        <div class="mb-3 password-access-section" style="display: none;">
                            <label for="accessPasswordInput" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="accessPasswordInput" placeholder="Ingresa la contraseña">
                            <div class="form-text">Ingresa la misma contraseña que usaste para proteger el enlace.</div>
                        </div>
                        
                        <button class="btn btn-primary" id="accessBtn">Acceder</button>
                        
                        <div class="error-message error-url" id="accessErrorUrl">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>La URL proporcionada no coincide con ningún enlace protegido por RAKURL Security. Verifica la URL e intenta nuevamente.
                        </div>
                        
                        <div class="error-message error-key" id="accessErrorKey">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>La llave ingresada es incorrecta o el archivo no es un .key válido. Asegúrate de usar el método de acceso correcto generado por RAKURL Security.
                        </div>
                        
                        <div class="success-message" id="accessSuccess">
                            <i class="bi bi-check-circle-fill me-2"></i>¡Acceso concedido por RAKURL Security! El enlace original ha sido descifrado correctamente.
                        </div>
                        
                        <div class="result-container" id="accessResult">
                            <hr>
                            <h5>Enlace Original</h5>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="originalUrl" readonly="">
                                <button class="btn btn-outline-secondary" type="button" id="copyOriginalUrl">Copiar</button>
                                <button class="btn btn-outline-primary" type="button" id="visitOriginalUrl">Visitar</button>
                            </div>
                        </div>
                        
                        <!-- Información de depuración -->
                            <div class="debug-info" id="debugInfo"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                ¿Cómo funciona RAKURL Security?
            </div>
            <div class="card-body">
                <p>RAKURL Security (RANDOM ACCESS KEY URL SECURITY) es una aplicación que te permite proteger y cifrar enlaces.</p>
                <ol>
                    <li><strong>Proteger un enlace:</strong> Ingresa la URL que deseas proteger. RAKURL Security generará automáticamente un archivo .key con números aleatorios o podrás usar una contraseña.</li>
                    <li><strong>Generar enlace protegido:</strong> RAKURL Security creará un enlace protegido que contiene la URL original cifrada con el método seleccionado.</li>
                    <li><strong>Acceder al enlace:</strong> Para acceder al enlace original, necesitarás el enlace protegido y el método de acceso que generó RAKURL Security al protegerlo.</li>
                </ol>
                <p class="mb-0"><strong>Nota:</strong> Toda la encriptación y desencriptación se realiza localmente en tu dispositivo. No se envía ninguna información a servidores externos, esto es completamente anónimo.</p>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Constantes para números mágicos
        const KEY_FILE_SIZE_BYTES = 12000;
        const PBKDF2_ITERATIONS = 10000;
        
        // Estado de la aplicación encapsulado
        const appState = {
            generatedKeyFile: null
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar área de arrastrar y soltar para acceso
            setupFileDropArea('fileDropAreaAccess', 'keyFileInputAccess');
            
            // Configurar eventos para cambiar entre métodos de protección
            document.getElementById('keyMethod').addEventListener('change', function() {
                document.querySelector('.key-method-section').style.display = 'block';
                document.querySelector('.password-section').style.display = 'none';
            });
            
            document.getElementById('passwordMethod').addEventListener('change', function() {
                document.querySelector('.key-method-section').style.display = 'none';
                document.querySelector('.password-section').style.display = 'block';
            });
            
            // Configurar eventos para cambiar entre métodos de acceso
            document.getElementById('keyAccessMethod').addEventListener('change', function() {
                document.querySelector('.key-access-section').style.display = 'block';
                document.querySelector('.password-access-section').style.display = 'none';
            });
            
            document.getElementById('passwordAccessMethod').addEventListener('change', function() {
                document.querySelector('.key-access-section').style.display = 'none';
                document.querySelector('.password-access-section').style.display = 'block';
            });
            
            // Botón para proteger enlace
            document.getElementById('protectBtn').addEventListener('click', protectUrl);
            
            // Botón para acceder a enlace
            document.getElementById('accessBtn').addEventListener('click', accessUrl);
            
            // Botones para copiar
            document.getElementById('copyProtectedUrl').addEventListener('click', function() {
                copyToClipboard('protectedUrl');
            });
            
            document.getElementById('copyOriginalUrl').addEventListener('click', function() {
                copyToClipboard('originalUrl');
            });
            
            // Botón para visitar enlace original
            document.getElementById('visitOriginalUrl').addEventListener('click', function() {
                const url = document.getElementById('originalUrl').value;
                if (url) {
                    window.open(url, '_blank');
                }
            });
            
            // Botón para descargar archivo .key
            document.getElementById('downloadKeyBtn').addEventListener('click', downloadKeyFile);
        });
        
        function setupFileDropArea(dropAreaId, fileInputId) {
            const dropArea = document.getElementById(dropAreaId);
            const fileInput = document.getElementById(fileInputId);
            
            // Prevenir comportamientos por defecto
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Resaltar área al arrastrar
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('is-active');
            }
            
            function unhighlight() {
                dropArea.classList.remove('is-active');
            }
            
            // Manejar archivos soltados
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // Verificar si el archivo tiene extensión .key
                    const file = files[0];
                    if (!file.name.toLowerCase().endsWith('.key')) {
                        showError('accessErrorKey', 'Por favor, selecciona un archivo con extensión .key');
                        return;
                    }
                    
                    fileInput.files = files;
                    updateFileDisplay(dropArea, file.name);
                }
            }
            
            // Manejar selección de archivo
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    if (!file.name.toLowerCase().endsWith('.key')) {
                        showError('accessErrorKey', 'Por favor, selecciona un archivo con extensión .key');
                        this.value = ''; // Limpiar el input
                        return;
                    }
                    updateFileDisplay(dropArea, file.name);
                }
            });
        }
        
        function updateFileDisplay(dropArea, fileName) {
            const fileMsg = dropArea.querySelector('.file-msg');
            fileMsg.textContent = `Archivo seleccionado: ${fileName}`;
        }
        
        // Función para mostrar errores
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'block';
            if (message) {
                errorElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${message}`;
            }
        }
        
        // Función para ocultar errores
        function hideError(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        // Función para generar un archivo .key con números aleatorios binarios
        function generateKeyFile() {
            // Crear un array de bytes aleatorios
            const keyArray = new Uint8Array(KEY_FILE_SIZE_BYTES);
            window.crypto.getRandomValues(keyArray);
            
            // Crear un blob con los datos
            const blob = new Blob([keyArray], { type: 'application/octet-stream' });
            
            // Crear un nombre de archivo único
            const timestamp = new Date().getTime();
            const fileName = `rakurl_key_${timestamp}.key`;
            
            // Almacenar el archivo para descarga posterior
            appState.generatedKeyFile = {
                blob: blob,
                name: fileName,
                data: keyArray
            };
            
            return appState.generatedKeyFile;
        }
        
        // Función para descargar el archivo .key
        function downloadKeyFile() {
            if (!appState.generatedKeyFile) {
                showError('protectErrorKey', 'No hay ningún archivo .key para descargar');
                return;
            }
            
            // Crear una URL para el blob
            const url = URL.createObjectURL(appState.generatedKeyFile.blob);
            
            // Crear un enlace temporal para la descarga
            const a = document.createElement('a');
            a.href = url;
            a.download = appState.generatedKeyFile.name;
            document.body.appendChild(a);
            a.click();
            
            // Limpiar
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Función para obtener la clave a partir de un archivo (usando SHA-256)
        async function getFileAsKey(fileInput) {
            return new Promise((resolve, reject) => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    reject(new Error('No se ha seleccionado ningún archivo'));
                    return;
                }
                
                const file = fileInput.files[0];
                
                // Verificar si el archivo tiene extensión .key
                if (!file.name.toLowerCase().endsWith('.key')) {
                    reject(new Error('El archivo debe tener extensión .key'));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    // Convertir el contenido del archivo a un WordArray de CryptoJS
                    const arrayBuffer = event.target.result;
                    const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
                    
                    // Calcular el hash SHA-256 de todo el archivo
                    const hash = CryptoJS.SHA256(wordArray);
                    resolve(hash.toString(CryptoJS.enc.Hex));
                };
                
                reader.onerror = function() {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Función para obtener la clave a partir de datos binarios (usando SHA-256)
        function getDataAsKey(data) {
            // Convertir el array de bytes a un WordArray de CryptoJS
            const wordArray = CryptoJS.lib.WordArray.create(data);
            
            // Calcular el hash SHA-256 de todo el archivo
            const hash = CryptoJS.SHA256(wordArray);
            return hash.toString(CryptoJS.enc.Hex);
        }
        
        // Función para derivar clave a partir de contraseña usando PBKDF2
        function deriveKeyFromPassword(password, salt) {
            return CryptoJS.PBKDF2(password, salt, {
                keySize: 256 / 32, // 256 bits
                iterations: PBKDF2_ITERATIONS
            }).toString(CryptoJS.enc.Hex);
        }
        
        // Función para cifrar URL con IV explícito
        function encryptUrl(url, key) {
            // Convertir la clave de hexadecimal a WordArray
            const keyWordArray = CryptoJS.enc.Hex.parse(key);
            
            // Generar un IV aleatorio de 16 bytes (128 bits)
            const iv = CryptoJS.lib.WordArray.random(16);
            
            // Cifrar la URL usando AES con modo CBC y PKCS7 padding
            const encrypted = CryptoJS.AES.encrypt(url, keyWordArray, { 
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            
            // Obtener el texto cifrado como WordArray
            const ciphertext = encrypted.ciphertext;
            
            // Combinar IV y texto cifrado
            const combined = iv.clone().concat(ciphertext);
            
            // Convertir a Base64 y hacer seguro para URL
            let base64 = combined.toString(CryptoJS.enc.Base64);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }
        
        // Función para descifrar URL con IV explícito
        function decryptUrl(encryptedData, key) {
            try {
                // Convertir la clave de hexadecimal a WordArray
                const keyWordArray = CryptoJS.enc.Hex.parse(key);
                
                // Convertir de URL-safe a Base64 estándar
                let base64 = encryptedData.replace(/-/g, '+').replace(/_/g, '/');
                
                // Añadir padding si es necesario
                while (base64.length % 4) {
                    base64 += '=';
                }
                
                // Parsear el Base64
                const combined = CryptoJS.enc.Base64.parse(base64);
                
                // Extraer IV (primeros 16 bytes) y ciphertext (el resto)
                const iv = CryptoJS.lib.WordArray.create(combined.words.slice(0, 4)); // 16 bytes = 4 words de 32 bits
                const ciphertext = CryptoJS.lib.WordArray.create(combined.words.slice(4));
                
                // Descifrar
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, keyWordArray, { 
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error('Error descifrando:', error);
                return null;
            }
        }
        
        async function protectUrl() {
            const urlInput = document.getElementById('urlInput');
            const resultContainer = document.getElementById('protectResult');
            const errorUrl = document.getElementById('protectErrorUrl');
            const errorKey = document.getElementById('protectErrorKey');
            const successMsg = document.getElementById('protectSuccess');
            const keyInfo = document.getElementById('keyInfo');
            const passwordInput = document.getElementById('passwordInput');
            const keyMethod = document.getElementById('keyMethod').checked;
            
            // Ocultar mensajes anteriores
            resultContainer.style.display = 'none';
            hideError('protectErrorUrl');
            hideError('protectErrorKey');
            successMsg.style.display = 'none';
            keyInfo.style.display = 'none';
            
            // Validar URL
            if (!urlInput.value) {
                showError('protectErrorUrl', 'La URL ingresada no es válida. Por favor, verifica e intenta nuevamente.');
                return;
            }
            
            try {
                let key;
                let salt = null;
                
                if (keyMethod) {
                    // Generar archivo .key
                    const keyFile = generateKeyFile();
                    
                    // Obtener clave del archivo generado usando SHA-256
                    key = getDataAsKey(keyFile.data);
                } else {
                    // Validar contraseña
                    if (!passwordInput.value) {
                        showError('protectErrorKey', 'Por favor, ingresa una contraseña para proteger el enlace.');
                        return;
                    }
                    
                    // Generar salt aleatorio
                    salt = CryptoJS.lib.WordArray.random(16);
                    
                    // Derivar clave de la contraseña usando PBKDF2
                    key = deriveKeyFromPassword(passwordInput.value, salt);
                }
                
                // Cifrar la URL con IV explícito
                const encrypted = encryptUrl(urlInput.value, key);
                
                // Crear URL protegida (usando la URL actual como base)
                let protectedUrl;
                if (salt) {
                    // Si usamos contraseña, incluir el salt en la URL
                    const saltBase64 = salt.toString(CryptoJS.enc.Base64).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                    protectedUrl = `${window.location.href.split('#')[0]}#${saltBase64}.${encrypted}`;
                } else {
                    protectedUrl = `${window.location.href.split('#')[0]}#${encrypted}`;
                }
                
                // Mostrar resultado
                document.getElementById('protectedUrl').value = protectedUrl;
                resultContainer.style.display = 'block';
                successMsg.style.display = 'block';
                
                if (keyMethod) {
                    keyInfo.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error al proteger la URL:', error);
                showError('protectErrorKey', 'Ocurrió un error al proteger la URL con RAKURL Security. Por favor, intenta nuevamente.');
            }
        }
        
        async function accessUrl() {
            const protectedUrlInput = document.getElementById('protectedUrlInput');
            const keyFileInput = document.getElementById('keyFileInputAccess');
            const accessPasswordInput = document.getElementById('accessPasswordInput');
            const resultContainer = document.getElementById('accessResult');
            const errorUrl = document.getElementById('accessErrorUrl');
            const errorKey = document.getElementById('accessErrorKey');
            const successMsg = document.getElementById('accessSuccess');
            const keyAccessMethod = document.getElementById('keyAccessMethod').checked;
            const debugInfo = document.getElementById('debugInfo');
            
            // Ocultar mensajes anteriores
            resultContainer.style.display = 'none';
            hideError('accessErrorUrl');
            hideError('accessErrorKey');
            successMsg.style.display = 'none';
            debugInfo.style.display = 'none';
            
            // Validar URL protegida
            if (!protectedUrlInput.value) {
                showError('accessErrorUrl', 'La URL proporcionada no coincide con ningún enlace protegido por RAKURL Security. Verifica la URL e intenta nuevamente.');
                return;
            }
            
            try {
                // Extraer el hash de la URL
                let encrypted;
                let salt = null;
                
                if (protectedUrlInput.value.includes('#')) {
                    const hashContent = protectedUrlInput.value.split('#')[1];
                    
                    // Verificar si contiene salt (formato: salt.encrypted)
                    if (hashContent.includes('.')) {
                        const parts = hashContent.split('.', 2); // Dividir en máximo 2 partes
                        salt = parts[0];
                        encrypted = parts[1];
                    } else {
                        encrypted = hashContent;
                    }
                } else {
                    // Si no hay hash, asumir que toda la URL es el texto cifrado
                    encrypted = protectedUrlInput.value;
                }
                
                if (!encrypted) {
                    showError('accessErrorUrl', 'La URL proporcionada no coincide con ningún enlace protegido por RAKURL Security. Verifica la URL e intenta nuevamente.');
                    return;
                }
                
                let key;
                
                if (keyAccessMethod) {
                    // Obtener clave del archivo usando SHA-256
                    key = await getFileAsKey(keyFileInput);
                } else {
                    // Validar contraseña
                    if (!accessPasswordInput.value) {
                        showError('accessErrorKey', 'Por favor, ingresa la contraseña para acceder al enlace.');
                        return;
                    }
                    
                    // Si no hay salt, no podemos usar contraseña
                    if (!salt) {
                        showError('accessErrorKey', 'Este enlace no fue protegido con contraseña. Por favor, usa el método de archivo .key.');
                        return;
                    }
                    
                    // Convertir salt de URL-safe a Base64 estándar
                    let saltBase64 = salt.replace(/-/g, '+').replace(/_/g, '/');
                    while (saltBase64.length % 4) {
                        saltBase64 += '=';
                    }
                    
                    // Parsear el salt
                    const saltWordArray = CryptoJS.enc.Base64.parse(saltBase64);
                    
                    // Derivar clave de la contraseña usando PBKDF2
                    key = deriveKeyFromPassword(accessPasswordInput.value, saltWordArray);
                    
                    // Depuración
                    debugInfo.innerHTML = `
                        <strong>Depuración:</strong><br>
                        Salt original: ${salt}<br>
                        Salt convertido: ${saltBase64}<br>
                        Contraseña: ${accessPasswordInput.value}<br>
                        Clave derivada: ${key}<br>
                        Texto cifrado: ${encrypted}
                    `;
                    debugInfo.style.display = 'block';
                }
                
                // Descifrar la URL
                const originalUrl = decryptUrl(encrypted, key);
                
                if (!originalUrl) {
                    showError('accessErrorKey', 'La llave ingresada es incorrecta o el archivo no es un .key válido. Asegúrate de usar el método de acceso correcto generado por RAKURL Security.');
                    return;
                }
                
                // Mostrar resultado
                document.getElementById('originalUrl').value = originalUrl;
                resultContainer.style.display = 'block';
                successMsg.style.display = 'block';
                debugInfo.style.display = 'none';
                
            } catch (error) {
                console.error('Error al acceder a la URL:', error);
                showError('accessErrorKey', 'La llave ingresada es incorrecta o el archivo no es un .key válido. Asegúrate de usar el método de acceso correcto generado por RAKURL Security.');
            }
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // Para dispositivos móviles
            
            navigator.clipboard.writeText(element.value)
                .then(() => {
                    // Cambiar temporalmente el texto del botón
                    const btn = document.querySelector(`#${elementId.replace('Url', 'Url')} + button`);
                    const originalText = btn.textContent;
                    btn.textContent = '¡Copiado!';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Error al copiar al portapapeles: ', err);
                });
        }
        
        // Comprobar si hay un enlace protegido en la URL actual
        window.addEventListener('load', function() {
            const hash = window.location.hash;
            if (hash && hash.length > 1) {
                // Cambiar a la pestaña de acceso
                document.getElementById('access-tab').click();
                
                // Rellenar el campo de enlace protegido
                document.getElementById('protectedUrlInput').value = window.location.href;
            }
        });
    </script>

</body></html>
