<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Nutricional Interactivo para Perros</title>
    <meta name="description" content="Plan nutricional para la recuperaci√≥n de caninos con anemia por Ehrlichia">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #005a9c;
            --secondary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: var(--border-radius);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background-color: var(--primary-color);
            color: #ffffff;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 26px;
        }

        .header p {
            margin: 5px 0 0;
            font-size: 18px;
            font-weight: 300;
        }

        .header .dog-icon {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
        }

        .content {
            padding: 30px;
        }

        .recipe-nav {
            display: flex;
            justify-content: space-around;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .recipe-nav button {
            background-color: #ddd;
            border: none;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .recipe-nav button:hover {
            background-color: #ccc;
        }

        .recipe-nav button.active {
            background-color: var(--primary-color);
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .recipe-nav button:focus {
            outline: 3px solid rgba(0, 90, 156, 0.5);
            outline-offset: 2px;
        }

        #recipe-display {
            min-height: 250px;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
            margin-top: 30px;
            position: relative;
        }

        h2 .icon {
            margin-right: 10px;
        }

        .meal-card {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .meal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background-color: var(--primary-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .meal-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.4rem;
        }

        .meal-card ul {
            list-style-type: none;
            padding-left: 0;
        }

        .meal-card ul li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 8px;
        }

        .meal-card ul li::before {
            content: 'üêæ';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--primary-color);
        }

        .spice-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .spice-list {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            border-radius: 8px;
        }

        .allowed {
            background-color: #e6f7f0;
            border: 1px solid #b7e4d0;
        }

        .prohibited {
            background-color: #fdeaea;
            border: 1px solid #f8c7c7;
        }

        .allowed h3 { 
            color: #00642e;
            display: flex;
            align-items: center;
        }
        
        .allowed h3 i {
            margin-right: 8px;
        }

        .prohibited h3 { 
            color: var(--danger-color);
            display: flex;
            align-items: center;
        }
        
        .prohibited h3 i {
            margin-right: 8px;
        }

        .prohibited li { 
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .prohibited li::before {
            content: '‚úñ';
            color: var(--danger-color);
            margin-right: 8px;
        }

        .instructions ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
        }
        
        /* --- ESTILOS CALENDARIO NUEVO --- */
        .calendar-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 14px;
        }
        .calendar-table th, .calendar-table td {
            border: 1px solid #ddd;
            padding: 10px;
            position: relative;
        }
        .calendar-table th {
            background-color: #f2f2f2;
            color: var(--dark-color);
            font-weight: 600;
        }
        .calendar-table td {
            height: 80px;
            vertical-align: top;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-table td:hover {
            background-color: #f0f8ff;
        }
        .calendar-table .day-number {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        .calendar-table .meal-type {
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
            font-weight: 500;
        }
        .calendar-table .meal-1 { background-color: #e3f2fd; color: #0d47a1; }
        .calendar-table .meal-2 { background-color: #e8f5e9; color: #2e7d32; }
        .calendar-table .meal-3 { background-color: #fff3e0; color: #e65100; }
        .calendar-table .meal-4 { background-color: #f3e5f5; color: #6a1b9a; }
        .calendar-table .meal-5 { background-color: #e0f7fa; color: #006064; }

        .calendar-table .current-day {
            background-color: rgba(0, 90, 156, 0.1);
            font-weight: bold;
            border: 2px solid var(--primary-color);
        }
        .calendar-table .current-day .day-number {
            color: var(--primary-color);
            font-size: 20px;
        }
        .calendar-table .completed-day {
            background-color: rgba(40, 167, 69, 0.1);
        }
        .calendar-table .completed-day::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--success-color);
            font-size: 14px;
        }
        .calendar-table .future-day { opacity: 0.7; }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-controls button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        .calendar-controls button:hover { background-color: #004d87; }
        .calendar-controls button:disabled { background-color: #ccc; cursor: not-allowed;}
        .calendar-controls button i { margin: 0 5px; }
        .calendar-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .calendar-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .day-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            display: none;
        }
        .day-details.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .day-details h3 { margin-top: 0; color: var(--primary-color); display: flex; align-items: center; }
        .day-details h3 i { margin-right: 8px; }
        .day-details .recipe-details { background-color: white; padding: 12px; border-radius: 6px; margin-top: 10px; }
        .day-details .recipe-details h4 { margin-top: 0; color: var(--dark-color); font-size: 16px; }
        .day-details .recipe-details ul { list-style-type: none; padding-left: 0; margin-top: 8px; }
        .day-details .recipe-details li { position: relative; padding-left: 25px; margin-bottom: 5px; }
        .day-details .recipe-details li::before { content: 'üêæ'; position: absolute; left: 0; top: 0; color: var(--primary-color); }
        .close-details { background: none; border: none; color: var(--gray-color); font-size: 20px; cursor: pointer; float: right; transition: var(--transition); }
        .close-details:hover { color: var(--danger-color); }
        
        /* --- ESTILOS ASISTENTE DE IA TIPO CHAT --- */
        .chat-bubble {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: var(--transition);
            /* Ocultar por defecto hasta que se guarde la API */
            display: none;
        }

        .chat-bubble.visible {
            display: flex;
        }

        .chat-bubble:hover {
            transform: scale(1.1);
            background-color: var(--secondary-color);
        }

        .ai-chat-window {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 90%;
            max-width: 370px;
            height: 70vh;
            max-height: 500px;
            background-color: #f0f2f5;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 999;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .ai-chat-window.hidden {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            pointer-events: none;
        }

        .ai-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            flex-shrink: 0;
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        
        .ai-chat-header h3 i {
            margin-right: 8px;
        }

        .chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            padding: 0 5px;
            transition: var(--transition);
        }
        
        .chat-close-btn:hover {
            transform: rotate(90deg);
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-message, .ai-message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user-message {
            background-color: var(--secondary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background-color: #fff;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e5e5;
        }

        .ai-message p {
            margin: 0;
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }

        .chat-input-area input {
            flex-grow: 1;
            border: none;
            padding: 10px;
            border-radius: 20px;
            background-color: #f0f2f5;
            outline: none;
            font-size: 16px;
        }

        .chat-input-area button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            transition: var(--transition);
        }
        
        .chat-input-area button:hover {
            color: var(--secondary-color);
            transform: scale(1.1);
        }

        .chat-input-area button svg, .chat-input-area button i {
            width: 24px;
            height: 24px;
        }

        .loader-container {
            align-self: flex-start;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--danger-color);
        }

        .notification.info {
            border-left: 4px solid var(--primary-color);
        }

        .notification i {
            margin-right: 10px;
            font-size: 20px;
        }

        .notification.success i { color: var(--success-color); }
        .notification.error i { color: var(--danger-color); }
        .notification.info i { color: var(--primary-color); }

        /* Bot√≥n de configuraci√≥n */
        .settings-btn {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 50px;
            height: 50px;
            background-color: var(--gray-color);
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: var(--transition);
        }

        .settings-btn:hover {
            background-color: #5a6268;
            transform: scale(1.1);
        }

        .settings-btn.api-needed {
            background-color: var(--danger-color);
            animation: pulse 2s infinite;
        }

        /* Panel de configuraci√≥n */
        .settings-panel {
            position: fixed;
            bottom: 90px;
            left: 25px;
            width: 90%;
            max-width: 320px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 999;
            padding: 20px;
            transition: var(--transition);
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            pointer-events: none;
        }

        .settings-panel.show {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .settings-panel h3 {
            margin-top: 0;
            color: var(--dark-color);
            display: flex;
            align-items: center;
        }
        
        .settings-panel h3 i {
            margin-right: 10px;
        }

        .settings-panel .form-group {
            margin-bottom: 15px;
        }
        
        .settings-panel .form-group input[type="password"] {
            font-family: monospace;
        }

        .settings-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .settings-panel input, .settings-panel select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .settings-panel .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .settings-panel button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .settings-panel .save-btn {
            background-color: var(--success-color);
            color: white;
        }

        .settings-panel .save-btn:hover {
            background-color: #218838;
        }

        .settings-panel .save-btn.saving {
            background-color: #218838;
            pointer-events: none;
        }

        .settings-panel .save-btn.saving i {
            animation: spin 1s linear infinite;
        }

        .settings-panel .save-btn.saved {
            background-color: var(--success-color);
        }

        .settings-panel .save-btn.saved::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 5px;
        }

        .settings-panel .cancel-btn {
            background-color: var(--gray-color);
            color: white;
        }

        .settings-panel .cancel-btn:hover {
            background-color: #5a6268;
        }

        /* Secci√≥n de progreso */
        .progress-section {
            margin-top: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .progress-header h3 { margin: 0; color: var(--dark-color); font-size: 18px; }
        .progress-text { font-weight: 500; color: var(--gray-color); }

        .progress-bar-container {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.15) 25%, transparent 25%,
                transparent 50%, rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%, transparent 75%,
                transparent
            );
            background-size: 30px 30px;
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            0% { background-position: 30px 0; }
            100% { background-position: 0 0; }
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--gray-color);
        }

        /* Mejoras de accesibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Dise√±o responsivo */
        @media (max-width: 768px) {
            .container { margin: 10px auto; }
            .header { padding: 15px 20px; }
            .header h1 { font-size: 22px; }
            .content { padding: 20px; }
            .calendar-table { font-size: 12px; }
            .calendar-table th, .calendar-table td { padding: 5px; }
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .recipe-nav button { padding: 10px 12px; font-size: 12px; }
            .meal-card h3 { font-size: 1.2rem; }
            .spice-section { flex-direction: column; }
        }

        /* Animaciones adicionales para la API */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .api-saved {
            animation: pulse 0.5s ease-in-out;
        }

        .api-error {
            animation: shake 0.5s ease-in-out;
        }

        /* Indicador de API guardada */
        .api-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .api-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .api-indicator i {
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="dog-icon"><i class="fas fa-dog"></i></div>
            <h1>Plan Nutricional de Apoyo</h1>
            <p>Recuperaci√≥n para Canino de <span id="dog-weight">20</span> kg</p>
        </div>
        <div class="content">
            
            <h2><i class="fas fa-utensils icon"></i>Recetas de Recuperaci√≥n</h2>
            <div class="recipe-nav" role="tablist" aria-label="Recetas de recuperaci√≥n">
                <button id="btn-1" class="recipe-btn" onclick="showRecipe(1)" role="tab" aria-selected="true" aria-controls="recipe-1">Receta 1</button>
                <button id="btn-2" class="recipe-btn" onclick="showRecipe(2)" role="tab" aria-selected="false" aria-controls="recipe-2">Receta 2</button>
                <button id="btn-3" class="recipe-btn" onclick="showRecipe(3)" role="tab" aria-selected="false" aria-controls="recipe-3">Receta 3</button>
                <button id="btn-4" class="recipe-btn" onclick="showRecipe(4)" role="tab" aria-selected="false" aria-controls="recipe-4">Receta 4</button>
                <button id="btn-5" class="recipe-btn" onclick="showRecipe(5)" role="tab" aria-selected="false" aria-controls="recipe-5">Receta 5</button>
            </div>
            
            <div id="recipe-display" role="tabpanel" aria-live="polite"></div>

            <h2><i class="fas fa-list-ul icon"></i>Indicaciones</h2>
            <div class="instructions">
                <ul>
                    <li><strong>Duraci√≥n:</strong> Siga este plan durante los <span id="plan-duration">30</span> d√≠as del tratamiento.</li>
                    <li><strong>Cantidad Total Diaria:</strong> Aprox. <strong id="daily-amount">600 a 800 gramos</strong> (ajuste seg√∫n apetito).</li>
                    <li><strong>Frecuencia:</strong> Divida la raci√≥n total en <strong>2 o 3 comidas peque√±as</strong> al d√≠a.</li>
                    <li><strong>Preparaci√≥n:</strong> Todos los ingredientes deben estar bien cocidos (hervidos o al vapor).</li>
                    <li><strong>Importante:</strong> No a√±ada sal, ajo, cebolla ni condimentos comerciales.</li>
                    <li><strong>Agua:</strong> Aseg√∫rese de que siempre tenga agua fresca y limpia disponible.</li>
                </ul>
            </div>

            <h2><i class="fas fa-pepper-hot icon"></i>Sazonadores: Permitidos y Prohibidos</h2>
            <div class="spice-section">
                <div class="spice-list allowed">
                    <h3><i class="fas fa-check-circle"></i> Permitidos (en Pizcas)</h3>
                    <ul>
                        <li><strong>C√∫rcuma:</strong> Una pizca.</li>
                        <li><strong>Perejil fresco:</strong> Muy poco, bien picado.</li>
                        <li><strong>Jengibre:</strong> Una pizca m√≠nima.</li>
                        <li><strong>Aceite de Oliva (extra virgen):</strong> 1 cucharadita sobre la comida ya servida.</li>
                    </ul>
                </div>
                <div class="spice-list prohibited">
                    <h3><i class="fas fa-times-circle"></i> ¬°TOTALMENTE PROHIBIDOS!</h3>
                    <ul>
                        <li>CEBOLLA (en todas sus formas)</li>
                        <li>AJO (en todas sus formas)</li>
                        <li>SAL (de mesa)</li>
                        <li>Pimienta / Chiles</li>
                        <li>Nuez moscada</li>
                    </ul>
                </div>
            </div>

            <div id="calendar-section">
                <h2><i class="fas fa-calendar-alt icon"></i>Calendario Nutricional</h2>
                <div class="calendar-controls">
                    <button id="prev-week" aria-label="Semana anterior"><i class="fas fa-chevron-left"></i> Anterior</button>
                    <div class="calendar-title" id="calendar-title">Plan de 30 d√≠as</div>
                    <button id="next-week" aria-label="Siguiente semana">Siguiente <i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-container">
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Lunes</th>
                                <th>Martes</th>
                                <th>Mi√©rcoles</th>
                                <th>Jueves</th>
                                <th>Viernes</th>
                                <th>S√°bado</th>
                                <th>Domingo</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body">
                        </tbody>
                    </table>
                </div>
                <div class="calendar-legend">
                    <div class="calendar-legend-item"><div class="calendar-legend-color" style="background-color: #e3f2fd;"></div><span>Comida 1</span></div>
                    <div class="calendar-legend-item"><div class="calendar-legend-color" style="background-color: #e8f5e9;"></div><span>Comida 2</span></div>
                    <div class="calendar-legend-item"><div class="calendar-legend-color" style="background-color: #fff3e0;"></div><span>Comida 3</span></div>
                    <div class="calendar-legend-item"><div class="calendar-legend-color" style="background-color: #f3e5f5;"></div><span>Comida 4</span></div>
                    <div class="calendar-legend-item"><div class="calendar-legend-color" style="background-color: #e0f7fa;"></div><span>Comida 5</span></div>
                </div>
                 <div id="day-details" class="day-details">
                    <button class="close-details" aria-label="Cerrar detalles"><i class="fas fa-times"></i></button>
                    <h3 id="day-details-title"><i class="fas fa-info-circle"></i> Detalles del D√≠a</h3>
                    <div class="recipe-details" id="recipe-details-content">
                    </div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-header">
                    <h3>Progreso del Plan</h3>
                    <span class="progress-text" id="progress-text">0 de 30 d√≠as</span>
                </div>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <span>Inicio: <span id="start-date"></span></span>
                    <span>Actual: <span id="current-date"></span></span>
                    <span>Final: <span id="end-date"></span></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Asistente de IA en ventana de chat -->
    <div id="ai-chat-window" class="ai-chat-window hidden" role="dialog" aria-labelledby="chat-title">
        <div class="ai-chat-header">
            <h3 id="chat-title"><i class="fas fa-robot"></i> Asistente de Cuidados</h3>
            <button id="close-chat-btn" class="chat-close-btn" aria-label="Cerrar chat">√ó</button>
        </div>
        <div id="chat-history" class="chat-history" aria-live="polite">
            <div class="ai-message">
                <p>¬°Hola! Soy tu asistente de cuidados. ¬øEn qu√© puedo ayudarte hoy?</p>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Escribe tu pregunta..." aria-label="Escribe tu pregunta">
            <button id="send-chat-btn" aria-label="Enviar mensaje">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Burbuja para abrir el chat (solo visible si hay API guardada) -->
    <button id="open-chat-bubble" class="chat-bubble" aria-label="Abrir asistente de cuidados">
        <i class="fas fa-comments"></i>
    </button>

    <!-- Bot√≥n de configuraci√≥n -->
    <button id="settings-btn" class="settings-btn" aria-label="Configuraci√≥n">
        <i class="fas fa-sliders-h"></i>
    </button>

    <!-- Panel de configuraci√≥n -->
    <div id="settings-panel" class="settings-panel">
        <div class="api-indicator" id="api-indicator">
            <i class="fas fa-check-circle"></i> API guardada
        </div>
        <h3><i class="fas fa-sliders-h"></i> Configuraci√≥n</h3>
        <div class="form-group">
            <label for="dog-weight-input">Peso del perro (kg):</label>
            <input type="number" id="dog-weight-input" min="1" max="100" step="0.5">
        </div>
        <div class="form-group">
            <label for="plan-duration-input">Duraci√≥n del plan (d√≠as):</label>
            <input type="number" id="plan-duration-input" min="1" max="365">
        </div>
         <div class="form-group">
            <label for="start-date-input">Fecha de Inicio del Plan:</label>
            <input type="date" id="start-date-input">
        </div>
        <div class="form-group">
            <label for="theme-select">Tema:</label>
            <select id="theme-select">
                <option value="default">Predeterminado</option>
                <option value="dark">Oscuro</option>
                <option value="high-contrast">Alto contraste</option>
            </select>
        </div>
         <div class="form-group">
            <label for="api-key-input">Clave de chat:</label>
            <input type="password" id="api-key-input" placeholder="Pega tu clave aqu√≠">
            <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                Necesitas una clave para activar el asistente de IA
            </small>
        </div>
        <div class="btn-group">
            <button id="save-settings" class="save-btn">Guardar</button>
            <button id="cancel-settings" class="cancel-btn">Cancelar</button>
        </div>
    </div>

    <!-- Notificaciones -->
    <div id="notification" class="notification" role="alert" aria-live="assertive">
        <i class="fas fa-info-circle"></i>
        <span id="notification-text"></span>
    </div>

<script>
    // Datos de las recetas
    const recipes = {
        1: {
            title: "Comida 1: Potencia de H√≠gado y Res",
            description: "El h√≠gado es el alimento estrella para la anemia por su alt√≠simo contenido de hierro y vitaminas B.",
            ingredients: ["<strong>150g</strong> de H√≠gado de res (cocido)", "<strong>150g</strong> de Carne molida de res (magra, cocida)", "<strong>100g</strong> de Arroz blanco (bien cocido)", "<strong>50g</strong> de Espinacas (cocidas y picadas)"]
        },
        2: {
            title: "Comida 2: Fest√≠n de Pollo y Huevo",
            description: "Prote√≠na de alta calidad y f√°cil digesti√≥n, con el poder de la yema de huevo.",
            ingredients: ["<strong>200g</strong> de Pechuga de pollo (cocida y desmenuzada)", "<strong>1 Huevo</strong> duro (cocido y picado)", "<strong>100g</strong> de Camote (papa dulce) (hervido y hecho pur√©)", "<strong>50g</strong> de Zanahoria (cocida y rallada)"]
        },
        3: {
            title: "Comida 3: Coraz√≥n y Lentejas",
            description: "El coraz√≥n es rico en taurina y hierro. Las lentejas aportan hierro de origen vegetal y fibra.",
            ingredients: ["<strong>200g</strong> de Coraz√≥n de res (bien cocido y picado finamente)", "<strong>100g</strong> de Lentejas (muy bien cocidas)", "<strong>100g</strong> de Calabaza (ayote) (cocida y hecha pur√©)", "<strong>50g</strong> de Br√≥coli (cocido al vapor)"]
        },
        4: {
            title: "Comida 4: Sorpresa de Pescado",
            description: "Las sardinas aportan Omega-3, que es un excelente antiinflamatorio natural.",
            ingredients: ["<strong>1 Lata</strong> de Sardinas (en agua, sin sal)", "<strong>150g</strong> de Pollo molido (cocido)", "<strong>100g</strong> de Papa (cocida y machacada)", "<strong>50g</strong> de Ch√≠charos (guisantes) (cocidos)"]
        },
        5: {
            title: "Comida 5: Caldo Sustancioso",
            description: "Ideal para d√≠as con poco apetito. Hidrata y nutre de forma suave.",
            ingredients: ["<strong>1 Taza</strong> de Caldo de hueso (casero, sin sal)", "<strong>200g</strong> de Muslos de pollo (cocidos y desmenuzados)", "<strong>100g</strong> de Arroz (sobre-cocido en el caldo)", "<strong>50g</strong> de Apio y Zanahoria (muy finos y cocidos)"]
        }
    };

    const mealPlan = [
        { day: 1, meal: 1 }, { day: 2, meal: 1 }, { day: 3, meal: 2 }, { day: 4, meal: 2 }, { day: 5, meal: 3 }, { day: 6, meal: 3 }, { day: 7, meal: 1 },
        { day: 8, meal: 4 }, { day: 9, meal: 4 }, { day: 10, meal: 5 }, { day: 11, meal: 5 }, { day: 12, meal: 2 }, { day: 13, meal: 2 }, { day: 14, meal: 3 },
        { day: 15, meal: 1 }, { day: 16, meal: 1 }, { day: 17, meal: 4 }, { day: 18, meal: 4 }, { day: 19, meal: 5 }, { day: 20, meal: 5 }, { day: 21, meal: 2 },
        { day: 22, meal: 3 }, { day: 23, meal: 3 }, { day: 24, meal: 1 }, { day: 25, meal: 1 }, { day: 26, meal: 2 }, { day: 27, meal: 4 }, { day: 28, meal: 5 },
        { day: 29, meal: 1 }, { day: 30, meal: 1 }
    ];

    // Variables globales
    let settings = {
        dogWeight: 20,
        planDuration: 30,
        currentDay: 0, // Se recalcular√° al cargar
        theme: 'default',
        startDate: new Date().toISOString().split('T')[0],
        apiKey: ''
    };

    // --- MANEJO DE CONFIGURACI√ìN ---
    function loadSettings() {
        const savedSettings = localStorage.getItem('nutritionPlanSettings');
        if (savedSettings) {
            settings = { ...settings, ...JSON.parse(savedSettings) };
        }
        updateCurrentDay();
        updateUIWithSettings();
        updateChatBubbleVisibility();
    }

    function saveSettings() {
        localStorage.setItem('nutritionPlanSettings', JSON.stringify(settings));
        showNotification('Configuraci√≥n guardada correctamente', 'success');
    }
    
    function updateCurrentDay() {
        const startDate = new Date(settings.startDate);
        const today = new Date();
        // Normalizar fechas a medianoche para una comparaci√≥n precisa
        startDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        
        const diffTime = today - startDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        settings.currentDay = Math.max(0, Math.min(diffDays, settings.planDuration -1));
    }

    function updateUIWithSettings() {
        // Actualizar textos principales
        document.getElementById('dog-weight').textContent = settings.dogWeight;
        document.getElementById('plan-duration').textContent = settings.planDuration;
        
        // Actualizar valores en el panel de configuraci√≥n
        document.getElementById('dog-weight-input').value = settings.dogWeight;
        document.getElementById('plan-duration-input').value = settings.planDuration;
        document.getElementById('start-date-input').value = settings.startDate;
        document.getElementById('api-key-input').value = settings.apiKey;

        const minAmount = Math.round(settings.dogWeight * 30);
        const maxAmount = Math.round(settings.dogWeight * 40);
        document.getElementById('daily-amount').textContent = `${minAmount} a ${maxAmount} gramos`;
        
        applyTheme(settings.theme);
    }

    function applyTheme(theme) {
        document.getElementById('theme-select').value = theme;
        document.body.className = '';
        if (theme === 'dark' || theme === 'high-contrast') {
            document.body.classList.add(theme + '-theme');
        }
    }
    
    const themeStyles = `
        body.dark-theme { background-color: #222; color: #ddd; }
        body.dark-theme .container, body.dark-theme .settings-panel, body.dark-theme .ai-chat-window { background-color: #333; color: #ddd; }
        body.dark-theme .meal-card, body.dark-theme .spice-list.allowed, body.dark-theme .spice-list.prohibited, body.dark-theme .progress-section, body.dark-theme .recipe-details, body.dark-theme .ai-message, body.dark-theme .day-details { background-color: #444; }
        body.dark-theme .calendar-table th { background-color: #555;}
        body.dark-theme .calendar-table td:hover { background-color: #4a4a4a;}
        body.high-contrast-theme { background-color: #000; color: #fff; }
        body.high-contrast-theme .container, body.high-contrast-theme .settings-panel { background-color: #000; color: #fff; border: 2px solid #fff; }
        body.high-contrast-theme h2, body.high-contrast-theme .day-number, body.high-contrast-theme label { color: #fff; }
    `;
    const styleSheet = document.createElement("style");
    styleSheet.innerText = themeStyles;
    document.head.appendChild(styleSheet);
    
    // --- L√ìGICA DE RECETAS ---
    function showRecipe(recipeId) {
        const recipe = recipes[recipeId];
        const display = document.getElementById('recipe-display');
        let html = `<div class="meal-card" id="recipe-${recipeId}" role="region" aria-labelledby="recipe-title-${recipeId}">
                        <h3 id="recipe-title-${recipeId}">${recipe.title}</h3>
                        <p>${recipe.description}</p><ul>`;
        recipe.ingredients.forEach(item => { html += `<li>${item}</li>`; });
        html += `</ul></div>`;
        display.innerHTML = html;
        
        document.querySelectorAll('.recipe-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        
        const activeBtn = document.getElementById(`btn-${recipeId}`);
        activeBtn.classList.add('active');
        activeBtn.setAttribute('aria-selected', 'true');
        
        localStorage.setItem('lastViewedRecipe', recipeId);
    }
    
    // --- L√ìGICA DE CALENDARIO Y PROGRESO ---
    let currentWeekOffset = 0; // Para navegar por semanas
    
    function renderCalendar() {
        const calendarBody = document.getElementById('calendar-body');
        calendarBody.innerHTML = '';
        const totalWeeks = Math.ceil(settings.planDuration / 7);
        const firstDayOfWeek = new Date(settings.startDate);
        firstDayOfWeek.setDate(firstDayOfWeek.getDate() - firstDayOfWeek.getDay() + 1 + (currentWeekOffset * 7)); // Ajustar al lunes de la semana actual

        const row = document.createElement('tr');
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(firstDayOfWeek);
            dayDate.setDate(firstDayOfWeek.getDate() + i);
            
            const diffTime = dayDate - new Date(settings.startDate);
            const dayNumber = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            const cell = document.createElement('td');
            if (dayNumber > 0 && dayNumber <= settings.planDuration) {
                const mealPlanEntry = mealPlan.find(entry => entry.day === dayNumber);
                const mealType = mealPlanEntry ? mealPlanEntry.meal : 0;

                let dayClass = '';
                if (dayNumber <= settings.currentDay + 1) dayClass = 'completed-day';
                if (dayNumber === settings.currentDay + 1) dayClass = 'current-day';
                
                cell.className = dayClass;
                cell.innerHTML = `
                    <div class="day-number">${dayNumber}</div>
                    <div class="meal-type meal-${mealType}">Comida ${mealType}</div>
                `;
                cell.addEventListener('click', () => showDayDetails(dayNumber, mealType));
            }
            row.appendChild(cell);
        }
        calendarBody.appendChild(row);

        document.getElementById('calendar-title').textContent = `Semana del ${formatDate(firstDayOfWeek)}`;
        document.getElementById('prev-week').disabled = currentWeekOffset === 0;
        document.getElementById('next-week').disabled = ((currentWeekOffset + 1) * 7) >= settings.planDuration;
    }


    function showDayDetails(dayNumber, mealType) {
        const recipe = recipes[mealType];
        const dayDetails = document.getElementById('day-details');
        document.getElementById('day-details-title').innerHTML = `<i class="fas fa-info-circle"></i> Detalles del D√≠a ${dayNumber}`;
        document.getElementById('recipe-details-content').innerHTML = `
            <h4>${recipe.title}</h4>
            <p>${recipe.description}</p>
            <h5>Ingredientes:</h5>
            <ul>${recipe.ingredients.map(ingredient => `<li>${ingredient}</li>`).join('')}</ul>
        `;
        dayDetails.classList.add('active');
    }

    function updateProgress() {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        // El d√≠a actual es settings.currentDay + 1
        const percentage = ((settings.currentDay + 1) / settings.planDuration) * 100;
        
        progressBar.style.width = `${Math.min(percentage, 100)}%`;
        progressText.textContent = `${settings.currentDay + 1} de ${settings.planDuration} d√≠as`;
        
        const startDate = new Date(settings.startDate);
        const currentDate = new Date();
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + settings.planDuration - 1);

        document.getElementById('start-date').textContent = formatDate(startDate);
        document.getElementById('current-date').textContent = formatDate(currentDate);
        document.getElementById('end-date').textContent = formatDate(endDate);
    }

    function formatDate(date) {
        return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }
    
    // --- L√ìGICA DEL CHAT ---
    async function sendChatMessage() {
        const userText = chatInput.value.trim();
        if (!userText) return;
        
        if (!settings.apiKey) {
            appendMessage('Por favor, a√±ade tu clave API en el panel de configuraci√≥n (<i class="fas fa-sliders-h"></i>) para usar el chat.', 'ai');
            return;
        }

        appendMessage(userText, 'user');
        chatInput.value = '';

        const loaderContainer = document.createElement('div');
        loaderContainer.classList.add('ai-message');
        loaderContainer.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
        chatHistory.appendChild(loaderContainer);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        
        const systemPrompt = `
            Eres un veterinario experto en nutrici√≥n canina y act√∫as como un asistente conversacional. Tu prop√≥sito es ayudar al due√±o de un perro de ${settings.dogWeight} kg que se recupera de anemia por Ehrlichia.
            Tus respuestas deben ser seguras, √∫tiles y basadas en el contexto de la recuperaci√≥n.
            Las reglas que NUNCA debes romper son:
            1. No recomiendes NUNCA ingredientes peligrosos como: cebolla, ajo, sal, pimienta, chiles, nuez moscada, az√∫car, chocolate, uvas, o condimentos comerciales.
            2. Si te piden una receta, debe ser altamente palatable, f√°cil de digerir y densa en nutrientes como hierro y vitaminas B, con ingredientes comunes.
            3. Si te preguntan por un ingrediente, analiza su seguridad, beneficios, y forma de preparaci√≥n para un perro convaleciente.
            4. Mant√©n un tono amigable, profesional y f√°cil de entender.
            5. Responde directamente a la pregunta del usuario. Formatea tus respuestas con p√°rrafos o listas para que sea f√°cil de leer.

            Aqu√≠ est√° la pregunta del usuario: "${userText}"
        `;

        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${settings.apiKey}`;
            const payload = { contents: [{ parts: [{ text: systemPrompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            chatHistory.removeChild(loaderContainer);
            appendMessage(text || 'No se pudo obtener una respuesta. Int√©ntelo de nuevo.', 'ai');
        } catch (error) {
            console.error("Error al llamar a la API de Gemini:", error);
            chatHistory.removeChild(loaderContainer);
            appendMessage('Ocurri√≥ un error de conexi√≥n o la clave API no es v√°lida. Por favor, verif√≠cala e int√©ntalo m√°s tarde.', 'ai');
        }
    }
    
    function appendMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add(`${sender}-message`);
        messageDiv.innerHTML = text;
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    // --- MANEJO DE VISIBILIDAD DE LA BURBUJA DE CHAT ---
    function updateChatBubbleVisibility() {
        const chatBubble = document.getElementById('open-chat-bubble');
        const settingsBtn = document.getElementById('settings-btn');
        
        if (settings.apiKey && settings.apiKey.trim() !== '') {
            // Mostrar burbuja de chat, bot√≥n de configuraci√≥n normal
            chatBubble.classList.add('visible');
            settingsBtn.classList.remove('api-needed');
        } else {
            // Ocultar burbuja de chat, bot√≥n de configuraci√≥n con indicador de API necesaria
            chatBubble.classList.remove('visible');
            settingsBtn.classList.add('api-needed');
        }
    }
    
    // --- INICIALIZACI√ìN Y EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // Cargar todo
        loadSettings();
        const lastRecipe = localStorage.getItem('lastViewedRecipe');
        showRecipe(lastRecipe ? parseInt(lastRecipe) : 1);
        renderCalendar();
        
        // --- Event Listeners ---
        // Chat
        document.getElementById('open-chat-bubble').addEventListener('click', () => {
            document.getElementById('ai-chat-window').classList.remove('hidden');
            document.getElementById('chat-input').focus();
        });
        document.getElementById('close-chat-btn').addEventListener('click', () => document.getElementById('ai-chat-window').classList.add('hidden'));
        document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
        
        // Configuraci√≥n
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-panel').classList.toggle('show');
            // Si no hay API, enfocar el campo de API
            if (!settings.apiKey || settings.apiKey.trim() === '') {
                setTimeout(() => {
                    document.getElementById('api-key-input').focus();
                }, 300);
            }
        });
        document.getElementById('cancel-settings').addEventListener('click', () => {
            updateUIWithSettings();
            document.getElementById('settings-panel').classList.remove('show');
        });
        
        // Evento para guardar configuraci√≥n con animaciones
        document.getElementById('save-settings').addEventListener('click', function() {
            const saveBtn = this;
            const apiInput = document.getElementById('api-key-input');
            const apiIndicator = document.getElementById('api-indicator');
            
            // Animaci√≥n de guardado
            saveBtn.classList.add('saving');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            saveBtn.disabled = true;
            
            // Simular tiempo de guardado para mostrar la animaci√≥n
            setTimeout(() => {
                // Obtener valores
                settings.dogWeight = parseFloat(document.getElementById('dog-weight-input').value) || 20;
                settings.planDuration = parseInt(document.getElementById('plan-duration-input').value) || 30;
                settings.startDate = document.getElementById('start-date-input').value;
                settings.theme = document.getElementById('theme-select').value;
                const newApiKey = document.getElementById('api-key-input').value.trim();
                
                // Verificar si se proporcion√≥ una API key
                if (newApiKey && newApiKey !== settings.apiKey) {
                    settings.apiKey = newApiKey;
                    
                    // Animaci√≥n de √©xito para API
                    apiIndicator.classList.add('show');
                    saveBtn.classList.remove('saving');
                    saveBtn.classList.add('saved');
                    saveBtn.innerHTML = 'Guardado';
                    
                    // A√±adir clase de animaci√≥n al contenedor del chat
                    document.getElementById('ai-chat-window').classList.add('api-saved');
                    
                    // Mostrar notificaci√≥n espec√≠fica para API
                    showNotification('¬°Clave API guardada correctamente! El asistente est√° listo para usarse.', 'success');
                    
                    // Actualizar visibilidad de la burbuja
                    updateChatBubbleVisibility();
                    
                    // Abrir el chat autom√°ticamente
                    setTimeout(() => {
                        document.getElementById('ai-chat-window').classList.remove('hidden');
                        appendMessage('¬°Clave API guardada correctamente! Ahora puedes preguntarme sobre el plan nutricional.', 'ai');
                        document.getElementById('chat-input').focus();
                    }, 1000);
                    
                    // Quitar animaciones despu√©s de un tiempo
                    setTimeout(() => {
                        apiIndicator.classList.remove('show');
                        saveBtn.classList.remove('saved');
                        document.getElementById('ai-chat-window').classList.remove('api-saved');
                        saveBtn.innerHTML = 'Guardar';
                        saveBtn.disabled = false;
                    }, 3000);
                } else {
                    // Guardado normal sin cambios en API
                    updateCurrentDay();
                    saveSettings();
                    updateUIWithSettings();
                    updateProgress();
                    renderCalendar();
                    document.getElementById('settings-panel').classList.remove('show');
                    
                    // Restaurar bot√≥n
                    saveBtn.classList.remove('saving');
                    saveBtn.innerHTML = 'Guardar';
                    saveBtn.disabled = false;
                    
                    // Actualizar visibilidad de la burbuja por si se borr√≥ la API
                    updateChatBubbleVisibility();
                }
            }, 1500); // 1.5 segundos para mostrar la animaci√≥n
        });

        // Calendario
        document.getElementById('prev-week').addEventListener('click', () => {
            if (currentWeekOffset > 0) {
                currentWeekOffset--;
                renderCalendar();
            }
        });
        document.getElementById('next-week').addEventListener('click', () => {
            if (((currentWeekOffset + 1) * 7) < settings.planDuration) {
                currentWeekOffset++;
                renderCalendar();
            }
        });
        document.querySelector('.close-details').addEventListener('click', () => document.getElementById('day-details').classList.remove('active'));
    });
</script>

</body></html>
